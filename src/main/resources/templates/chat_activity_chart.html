<div class="bg-white border p-2 mb-3">
    <div id="activity-chart"></div>
</div>
<script>
    function buildChart(response) {
        var sample = response['data'][0][0];
        var format = resolveFormat(sample);
        Morris.Line({
            element: 'activity-chart',
            data: response['data'],
            xkey: response['xKey'],
            ykeys: response['yKeys'],
            labels: response['labels'],
            xLabelFormat: format,
            dateFormat: format,
            hideHover: true
        });
    }

    $(document).ready(function () {
        var path = window.location.pathname + "activity-chart/";
        var interval = resolveInterval();
        var param = $.param({
            from: $('#fromDate').val(),
            to: $('#toDate').val(),
            interval: interval[0],
            interval_unit: interval[1]
        });
        $.get(path + "?" + param)
            .done(function (response) {
                if (response['data'].length) {
                    buildChart(response);
                } else {
                    $('#activity-chart').parent().replaceWith(
                        '<div class="alert-info p-3 mb-3">' +
                        'No data found for the selected period' +
                        '</div>');
                }
            });
    });

    function resolveInterval() {
        var from = getDate($('#fromDate').val());
        var to = getDate($('#toDate').val());
        var durationMills = to.getTime() - from.getTime();
        var durationDays = durationMills / (1000 * 60 * 60 * 24);
        if (durationDays === 0) {
            return [1, 'HOUR']
        } else if (durationDays <= 3) {
            return [3, 'HOUR']
        } else if (durationDays <= 31) {
            return [1, 'DAY']
        } else if (durationDays <= 31 + 31 + 30) {
            return [7, 'DAY']
        } else if (durationDays <= 366) {
            return [1, 'MONTH']
        } else if (durationDays <= 366 + 365) {
            return [3, 'MONTH']
        } else {
            return [1, 'YEAR']
        }
    }

    function getDate(str) {
        var a = str.split('.');
        return new Date(new Date(a[2], a[1] - 1, a[0]));
    }
</script>